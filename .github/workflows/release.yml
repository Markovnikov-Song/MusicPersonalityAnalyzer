name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install build twine pyinstaller
    
    - name: Run tests
      run: |
        python -c "import app; print('App imports successfully')"
        python -c "from music_analyzer import MusicAnalyzer; print('MusicAnalyzer works')"
        python -c "from mbti_predictor import MBTIPredictor; print('MBTIPredictor works')"
    
    - name: Build package
      run: |
        python -m build
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --console --add-data "templates;templates" --hidden-import flask --hidden-import requests --hidden-import pandas --hidden-import sklearn --hidden-import numpy --hidden-import bs4 --hidden-import lxml --hidden-import dotenv --hidden-import music_analyzer --hidden-import mbti_predictor --hidden-import playlist_importer --hidden-import kugou_api --hidden-import mock_data_generator --collect-all sklearn --collect-all pandas --name MusicPersonalityAnalyzer app.py
        dir dist
    
    - name: Create release archive
      run: |
        mkdir release-package
        copy *.py release-package\
        xcopy templates release-package\templates\ /E /I
        copy requirements.txt release-package\
        copy start.bat release-package\
        copy README.md release-package\
        copy LICENSE release-package\
        copy CHANGELOG.md release-package\
        cd release-package && Compress-Archive -Path * -DestinationPath ../music-personality-analyzer-${{ github.ref_name }}.zip
    
    - name: Check files exist
      run: |
        echo "Checking files..."
        dir ./music-personality-analyzer-${{ github.ref_name }}.zip
        dir ./dist/MusicPersonalityAnalyzer.exe
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Music Personality Analyzer ${{ github.ref_name }}
        body: |
          ## Music Personality Analyzer ${{ github.ref_name }}
          
          ### Download Options:
          - **Windows Executable**: MusicPersonalityAnalyzer.exe (No Python installation required)
          - **Source Code**: music-personality-analyzer-${{ github.ref_name }}.zip
          
          ### Quick Start:
          **Method 1: Using exe file**
          1. Download MusicPersonalityAnalyzer.exe
          2. Double click to run
          3. Visit http://localhost:5000 in your browser
          
          **Method 2: Using source code**
          1. Download and extract the source package
          2. Double click `start.bat` (Windows) or run `python app.py`
          3. Visit http://localhost:5000 in your browser
          
          ### Features:
          - Multi-platform playlist support (NetEase Cloud Music, QQ Music, Kugou)
          - Intelligent music style and emotion analysis
          - MBTI personality type prediction
          - Beautiful web user interface
        files: |
          music-personality-analyzer-${{ github.ref_name }}.zip
          dist/MusicPersonalityAnalyzer.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Publish to PyPI
      if: false
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        dir dist
        twine upload dist/*.tar.gz dist/*.whl --skip-existing || echo "PyPI upload failed or skipped"