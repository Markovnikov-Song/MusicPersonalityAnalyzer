name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install build twine
    
    - name: Run tests
      run: |
        python -c "import app; print('App imports successfully')"
        python -c "from music_analyzer import MusicAnalyzer; print('MusicAnalyzer works')"
        python -c "from mbti_predictor import MBTIPredictor; print('MBTIPredictor works')"
    
    - name: Build package
      run: |
        python -m build
    
    - name: Create release archive
      run: |
        mkdir release-package
        cp -r *.py templates requirements.txt start.bat README.md LICENSE CHANGELOG.md .env release-package/
        cd release-package && zip -r ../music-personality-analyzer-${{ github.ref_name }}.zip .
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: éŸ³ä¹æ€§æ ¼åˆ†æå™¨ ${{ github.ref_name }}
        body: |
          ## ğŸµ éŸ³ä¹æ€§æ ¼åˆ†æå™¨ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½æ–¹å¼
          - **æºç åŒ…**: music-personality-analyzer-${{ github.ref_name }}.zip
          - **PythonåŒ…**: é€šè¿‡ `pip install music-personality-analyzer` å®‰è£…
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½æºç åŒ…å¹¶è§£å‹
          2. åŒå‡» `start.bat` (Windows) æˆ–è¿è¡Œ `python app.py`
          3. æµè§ˆå™¨è®¿é—® http://localhost:5000
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - æ”¯æŒå¤šå¹³å°æ­Œå•å¯¼å…¥ï¼ˆç½‘æ˜“äº‘ã€QQéŸ³ä¹ã€é…·ç‹—ï¼‰
          - æ™ºèƒ½éŸ³ä¹é£æ ¼å’Œæƒ…ç»ªåˆ†æ
          - MBTIæ€§æ ¼ç±»å‹é¢„æµ‹
          - ç¾è§‚çš„Webç”¨æˆ·ç•Œé¢
          
          æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        draft: false
        prerelease: false
    
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./music-personality-analyzer-${{ github.ref_name }}.zip
        asset_name: music-personality-analyzer-${{ github.ref_name }}.zip
        asset_content_type: application/zip
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/* --skip-existing